// ============================================================================
// HRMS Database Schema — dbdiagram.io (DBML)
// Converted from schema.revised.postgres.sql
// ============================================================================

// ============================================================================
// 0. DATA-DRIVEN CATALOG (lookup / enum replacement)
// ============================================================================

Table catalog_categories {
  id uuid [pk, default: `gen_random_uuid()`]
  category_code varchar(50) [not null, unique, note: "e.g. 'GENDER', 'WORK_STATUS'"]
  category_name varchar(255) [not null, note: 'human-readable label']
  description text
  is_system boolean [not null, default: false, note: 'true = cannot be deleted by users']
  created_at timestamptz [not null, default: `now()`]
}

Table catalog_items {
  id uuid [pk, default: `gen_random_uuid()`]
  category_id uuid [not null, ref: > catalog_categories.id]
  code varchar(50) [not null, note: "machine key: 'NAM', 'NU', 'KHAC'"]
  label varchar(255) [not null, note: "display: 'Nam', 'Nữ', 'Khác'"]
  description text
  sort_order int [not null, default: 0]
  is_default boolean [not null, default: false]
  is_active boolean [not null, default: true]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    category_id
    code
    (category_id, code) [unique]
  }
}

// ============================================================================
// 1. FILES (uploads)
// ============================================================================

Table files {
  id uuid [pk, default: `gen_random_uuid()`]
  storage_path text [not null]
  original_name text [not null]
  mime_type text
  byte_size bigint
  sha256 char(64)
  uploaded_by_user_id uuid [ref: > auth_users.id]
  uploaded_at timestamptz [not null, default: `now()`]
}

// ============================================================================
// 2. CAMPUSES (đa cơ sở)
// ============================================================================

Table campuses {
  id uuid [pk, default: `gen_random_uuid()`]
  campus_code varchar(50) [not null, unique]
  campus_name varchar(255) [not null]
  address text
  phone varchar(30)
  email varchar(255)
  is_active boolean [not null, default: true]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
}

// ============================================================================
// 3. ORGANIZATION UNITS (cây cơ cấu tổ chức)
// ============================================================================

Table org_units {
  id uuid [pk, default: `gen_random_uuid()`]
  campus_id uuid [not null, ref: > campuses.id]
  parent_id uuid [ref: > org_units.id, note: 'self-referencing tree']
  unit_code varchar(50) [not null, unique]
  unit_name varchar(255) [not null]
  unit_type varchar(30) [not null, note: "catalog: ORG_UNIT_TYPE"]
  founded_on date
  address text
  office_address text
  email varchar(255)
  phone varchar(30)
  website text
  is_leaf_confirmed boolean [not null, default: false]
  status varchar(20) [not null, default: 'active', note: "catalog: ORG_UNIT_STATUS"]
  status_updated_at timestamptz
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    parent_id
    campus_id
    status
  }
}

Table org_unit_status_events {
  id uuid [pk, default: `gen_random_uuid()`]
  org_unit_id uuid [not null, ref: > org_units.id]
  event_type varchar(20) [not null, note: "catalog: ORG_EVENT_TYPE (DISSOLVE, MERGE)"]
  effective_on date [not null]
  decision_no varchar(50)
  decision_on date
  decision_file_id uuid [ref: > files.id]
  reason varchar(30) [not null, note: "catalog: ORG_EVENT_REASON"]
  note text
  merged_into_org_unit_id uuid [ref: > org_units.id]
  created_by_user_id uuid [ref: > auth_users.id]
  created_at timestamptz [not null, default: `now()`]

  indexes {
    org_unit_id
    effective_on
  }
}

// ============================================================================
// 4. SALARY GRADE & STEP CATALOG
// ============================================================================

// 4a. Salary Grades (Ngạch viên chức) — one row per grade
Table salary_grades {
  id uuid [pk, default: `gen_random_uuid()`]
  grade_code varchar(50) [not null, unique, note: "Mã ngạch, e.g. 'VC.A1', 'CV.A2'"]
  grade_name varchar(255) [not null, note: "Tên ngạch, e.g. 'Viên chức loại A1'"]
  status varchar(20) [not null, default: 'active', note: "catalog: CATALOG_STATUS"]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    grade_code
    status
  }
}

// 4b. Salary Grade Steps (Bậc lương) — one row per step within a grade
Table salary_grade_steps {
  id uuid [pk, default: `gen_random_uuid()`]
  salary_grade_id uuid [not null, ref: > salary_grades.id, note: 'CASCADE delete']
  step_no int [not null, note: 'Bậc (must be > 0)']
  coefficient decimal(8,3) [not null, note: 'Hệ số lương (must be >= 0)']
  status varchar(20) [not null, default: 'active', note: "catalog: CATALOG_STATUS"]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    salary_grade_id
    status
    (salary_grade_id, step_no) [unique]
  }
}

// ============================================================================
// 5. ALLOWANCE TYPES
// ============================================================================

Table allowance_types {
  id uuid [pk, default: `gen_random_uuid()`]
  allowance_name varchar(200) [not null, unique]
  description text
  calc_method text
  status varchar(20) [not null, default: 'active', note: "catalog: CATALOG_STATUS"]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
}

// ============================================================================
// 6. EMPLOYEES (core dossier)
// ============================================================================

Table employees {
  id uuid [pk, default: `gen_random_uuid()`]
  staff_code varchar(30) [not null, unique]
  full_name varchar(255) [not null]
  dob date [not null]
  gender varchar(10) [not null, note: "catalog: GENDER"]
  national_id varchar(20) [not null, unique, note: 'CCCD']
  hometown text
  address text [not null]
  tax_code varchar(30)
  social_insurance_no varchar(30)
  health_insurance_no varchar(30)
  email varchar(255) [not null]
  phone varchar(30) [not null]
  is_foreigner boolean [not null, default: false]
  education_level varchar(50) [note: "catalog: EDUCATION_LEVEL"]
  training_level varchar(50) [note: "catalog: TRAINING_LEVEL"]
  academic_title varchar(50) [note: "catalog: ACADEMIC_TITLE"]
  academic_rank varchar(50) [note: "catalog: ACADEMIC_RANK"]
  work_status varchar(20) [not null, default: 'pending', note: "catalog: WORK_STATUS"]
  contract_status varchar(20) [not null, default: 'none', note: "catalog: CONTRACT_STATUS"]
  current_org_unit_id uuid [ref: > org_units.id]
  current_position_title varchar(255) [note: 'Chức vụ đơn vị']
  salary_grade_step_id uuid [ref: > salary_grade_steps.id, note: 'Points to the specific step (bậc) within a grade']
  portrait_file_id uuid [ref: > files.id]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    staff_code
    national_id
    current_org_unit_id
    work_status
    contract_status
    gender
  }
}

// ============================================================================
// 6a. EMPLOYEE TERMINATIONS
// ============================================================================

Table employee_terminations {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null, ref: > employees.id]
  terminated_on date [not null]
  reason text [not null]
  is_auto boolean [not null, default: false, note: 'true when triggered by FEAT 6.6']
  created_by_user_id uuid [ref: > auth_users.id]
  created_at timestamptz [not null, default: `now()`]

  indexes {
    employee_id
  }
}

// ============================================================================
// 6b. ASSIGNMENT HISTORY (bổ nhiệm/bãi nhiệm)
// ============================================================================

Table employee_assignments {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null, ref: > employees.id]
  org_unit_id uuid [not null, ref: > org_units.id]
  position_title varchar(255)
  event_type varchar(20) [not null, default: 'APPOINT', note: "catalog: ASSIGNMENT_EVENT_TYPE"]
  started_on date [not null]
  ended_on date
  note text
  created_by_user_id uuid [ref: > auth_users.id]
  created_at timestamptz [not null, default: `now()`]

  indexes {
    employee_id
    org_unit_id
    event_type
  }
}

// ============================================================================
// 7. EMPLOYEE SUB-ENTITIES
// ============================================================================

// 7a. Family members
Table employee_family_members {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null, ref: > employees.id]
  relation varchar(30) [not null, note: "catalog: FAMILY_RELATION"]
  full_name varchar(255) [not null]
  dob date
  phone varchar(30)
  note text
  is_dependent boolean [not null, default: false]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    employee_id
  }
}

// 7b. Bank accounts
Table employee_bank_accounts {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null, ref: > employees.id]
  bank_name varchar(255) [not null]
  account_no varchar(50) [not null]
  is_primary boolean [not null, default: true]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    (employee_id, account_no) [unique]
  }
}

// 7c. Previous jobs
Table employee_previous_jobs {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null, ref: > employees.id]
  workplace varchar(255) [not null]
  started_on date
  ended_on date
  note text
  created_at timestamptz [not null, default: `now()`]
}

// 7d. Party memberships (Đảng/Đoàn)
Table employee_party_memberships {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null, ref: > employees.id]
  organization_type varchar(10) [not null, note: "catalog: PARTY_ORG_TYPE (DOAN, DANG)"]
  joined_on date
  details text
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
}

// 7e. Degrees (bằng cấp)
Table employee_degrees {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null, ref: > employees.id]
  degree_name varchar(255) [not null]
  school varchar(255) [not null]
  major varchar(255)
  graduation_year int
  classification varchar(100)
  degree_file_id uuid [ref: > files.id]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
}

// 7f. Certifications (chứng chỉ)
Table employee_certifications {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null, ref: > employees.id]
  cert_name varchar(255) [not null]
  issued_by varchar(255)
  issued_on date
  expires_on date
  cert_file_id uuid [ref: > files.id]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
}

// 7g. Foreign work permits
Table employee_foreign_work_permits {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null, ref: > employees.id]
  visa_no varchar(50)
  visa_expires_on date
  passport_no varchar(50)
  passport_expires_on date
  work_permit_no varchar(50)
  work_permit_expires_on date
  work_permit_file_id uuid [ref: > files.id]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
}

// ============================================================================
// 8. EMPLOYEE ALLOWANCES
// ============================================================================

Table employee_allowances {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null, ref: > employees.id]
  allowance_type_id uuid [not null, ref: > allowance_types.id]
  amount decimal(14,2)
  note text
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    (employee_id, allowance_type_id) [unique]
  }
}

// ============================================================================
// 9. CONTRACT TYPES
// ============================================================================

Table contract_types {
  id uuid [pk, default: `gen_random_uuid()`]
  contract_type_name varchar(255) [not null, unique]
  min_months int [not null]
  max_months int [not null]
  max_renewals int [not null]
  renewal_grace_days int [not null]
  status varchar(20) [not null, default: 'active', note: "catalog: CATALOG_STATUS"]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
}

// ============================================================================
// 10. EMPLOYMENT CONTRACTS
// ============================================================================

Table employment_contracts {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null, ref: > employees.id]
  contract_type_id uuid [not null, ref: > contract_types.id]
  contract_no varchar(50) [not null, unique]
  signed_on date [not null]
  effective_from date [not null]
  effective_to date [not null]
  org_unit_id uuid [not null, ref: > org_units.id]
  renewal_count int [not null, default: 0]
  previous_contract_id uuid [ref: > employment_contracts.id]
  status varchar(20) [not null, default: 'valid', note: "catalog: CONTRACT_DOC_STATUS"]
  content_html text
  contract_file_id uuid [ref: > files.id]
  created_by_user_id uuid [ref: > auth_users.id]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    employee_id
    contract_type_id
    org_unit_id
    status
    (effective_from, effective_to)
  }
}

Table contract_appendices {
  id uuid [pk, default: `gen_random_uuid()`]
  contract_id uuid [not null, ref: > employment_contracts.id]
  appendix_no varchar(50)
  effective_on date [not null]
  terms text [not null]
  notes text
  appendix_file_id uuid [ref: > files.id]
  created_by_user_id uuid [ref: > auth_users.id]
  created_at timestamptz [not null, default: `now()`]

  indexes {
    contract_id
  }
}

// ============================================================================
// 11. EVALUATIONS (Khen thưởng/Kỷ luật)
// ============================================================================

Table employee_evaluations {
  id uuid [pk, default: `gen_random_uuid()`]
  employee_id uuid [not null, ref: > employees.id]
  eval_type varchar(20) [not null, note: "catalog: EVAL_TYPE (REWARD / DISCIPLINE)"]
  reward_type varchar(255)
  reward_name varchar(255)
  decision_on date
  decision_no varchar(50)
  content text
  reward_amount decimal(14,2)
  discipline_type varchar(255)
  discipline_name varchar(255)
  reason text
  action_form varchar(255)
  is_active boolean [not null, default: true]
  visible_to_employee boolean [not null, default: true]
  visible_to_tckt boolean [not null, default: true]
  created_by_user_id uuid [ref: > auth_users.id]
  created_at timestamptz [not null, default: `now()`]

  indexes {
    employee_id
    eval_type
  }
}

// ============================================================================
// 12. TRAINING
// ============================================================================

Table training_course_types {
  id uuid [pk, default: `gen_random_uuid()`]
  type_name varchar(255) [not null, unique]
  description text
  status varchar(20) [not null, default: 'active', note: "catalog: CATALOG_STATUS"]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
}

Table training_courses {
  id uuid [pk, default: `gen_random_uuid()`]
  course_name varchar(255) [not null]
  course_type_id uuid [not null, ref: > training_course_types.id]
  training_from date [not null]
  training_to date [not null]
  location varchar(255)
  cost decimal(14,2)
  commitment text
  certificate_name varchar(255)
  certificate_type varchar(255)
  registration_from date
  registration_to date
  registration_limit int
  status varchar(30) [not null, default: 'draft', note: "catalog: TRAINING_STATUS"]
  created_by_user_id uuid [ref: > auth_users.id]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  indexes {
    course_type_id
    status
    (registration_from, registration_to)
  }
}

Table training_registrations {
  id uuid [pk, default: `gen_random_uuid()`]
  course_id uuid [not null, ref: > training_courses.id]
  employee_id uuid [not null, ref: > employees.id]
  registered_at timestamptz [not null, default: `now()`]
  participation_status varchar(20) [not null, default: 'registered', note: "catalog: PARTICIPATION_STATUS"]

  indexes {
    employee_id
    course_id
    (course_id, employee_id) [unique]
  }
}

Table training_results {
  id uuid [pk, default: `gen_random_uuid()`]
  registration_id uuid [not null, unique, ref: > training_registrations.id]
  result_status varchar(20) [not null, note: "catalog: RESULT_STATUS (completed/failed)"]
  completed_on date
  certificate_file_id uuid [ref: > files.id]
  note text
  created_by_user_id uuid [ref: > auth_users.id]
  created_at timestamptz [not null, default: `now()`]
}

// ============================================================================
// 13. AUTH: USERS / ROLES / PERMISSIONS
// ============================================================================

Table auth_users {
  id uuid [pk, default: `gen_random_uuid()`]
  username varchar(50) [not null, unique]
  password_hash text [not null]
  full_name varchar(255) [not null]
  email varchar(255) [unique]
  employee_id uuid [unique, ref: > employees.id]
  status varchar(20) [not null, default: 'active', note: "catalog: AUTH_USER_STATUS"]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
  last_login_at timestamptz

  indexes {
    employee_id
    status
  }
}

Table auth_roles {
  id uuid [pk, default: `gen_random_uuid()`]
  role_code varchar(30) [not null, unique, note: 'ADMIN, TCCB, TCKT, EMPLOYEE']
  role_name varchar(255) [not null]
  description text
  is_system boolean [not null, default: false]
  created_at timestamptz [not null, default: `now()`]
}

Table auth_user_roles {
  user_id uuid [not null, ref: > auth_users.id]
  role_id uuid [not null, ref: > auth_roles.id]
  granted_at timestamptz [not null, default: `now()`]
  granted_by_user_id uuid [ref: > auth_users.id]

  indexes {
    (user_id, role_id) [pk]
  }
}

// NOTE: Field-level permissions have been removed.
//       Permission enforcement is handled at the feature level in the application codebase.

// ============================================================================
// 14. BETTER-AUTH MANAGED TABLES (session / account / verification)
// ============================================================================

Table session {
  id text [pk]
  expiresAt timestamptz [not null]
  token text [not null, unique]
  createdAt timestamptz [not null, default: `now()`]
  updatedAt timestamptz [not null, default: `now()`]
  ipAddress text
  userAgent text
  userId uuid [not null, ref: > auth_users.id]

  indexes {
    userId
    token
    expiresAt
  }
}

Table account {
  id text [pk]
  accountId text [not null]
  providerId text [not null]
  userId uuid [not null, ref: > auth_users.id]
  accessToken text
  refreshToken text
  idToken text
  accessTokenExpiresAt timestamptz
  refreshTokenExpiresAt timestamptz
  scope text
  password text
  createdAt timestamptz [not null, default: `now()`]
  updatedAt timestamptz [not null, default: `now()`]

  indexes {
    userId
  }
}

Table verification {
  id text [pk]
  identifier text [not null]
  value text [not null]
  expiresAt timestamptz [not null]
  createdAt timestamptz [not null, default: `now()`]
  updatedAt timestamptz [not null, default: `now()`]
}

// ============================================================================
// 15. AUDIT LOG
// ============================================================================

Table audit_logs {
  id uuid [pk, default: `gen_random_uuid()`]
  actor_user_id uuid [ref: > auth_users.id]
  action varchar(100) [not null]
  entity_type varchar(100)
  entity_id uuid
  old_values jsonb [note: 'snapshot before change']
  new_values jsonb [note: 'snapshot after change']
  ip_address text
  user_agent text
  metadata jsonb
  created_at timestamptz [not null, default: `now()`]

  indexes {
    actor_user_id
    (entity_type, entity_id)
    created_at
    action
  }
}
